<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lavella Admin | Premium Portal</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      :root {
        --primary: #c5a059;
        --primary-light: #d4b884;
        --primary-dark: #a68545;
        --bg: #0f172a;
        --sidebar: #1e293b;
        --card: #1e293b;
        --text: #f8fafc;
        --text-dim: #94a3b8;
        --border: rgba(255, 255, 255, 0.05);
        --danger: #ef4444;
        --success: #22c55e;
        --warning: #f59e0b;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Outfit", sans-serif;
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
        overflow-x: hidden;
      }

      /* Unified Transitions */
      .page-view {
        display: none;
        animation: fadeIn 0.4s ease-out;
      }
      .page-view.active {
        display: block;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Login Layout */
      #loginView {
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      }
      .login-card {
        background: rgba(30, 41, 59, 0.7);
        backdrop-filter: blur(12px);
        padding: 3rem;
        border-radius: 24px;
        border: 1px solid var(--border);
        width: 100%;
        max-width: 450px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      }
      .login-card h1 {
        color: var(--primary);
        text-align: center;
        font-size: 2.5rem;
        letter-spacing: 4px;
        margin-bottom: 0.5rem;
      }
      .login-card p {
        text-align: center;
        color: var(--text-dim);
        margin-bottom: 2rem;
      }

      /* Dashboard Layout */
      #adminLayout {
        display: flex;
        min-height: 100vh;
      }

      /* Sidebar */
      .sidebar {
        width: 260px;
        background: var(--sidebar);
        padding: 2rem;
        display: flex;
        flex-direction: column;
        border-right: 1px solid var(--border);
        overflow-y: auto;
        height: 100vh;
        position: sticky;
        top: 0;
      }
      .logo {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--primary);
        letter-spacing: 2px;
        margin-bottom: 3rem;
        text-decoration: none;
        display: block;
      }
      .nav-link {
        text-decoration: none;
        color: var(--text-dim);
        display: flex;
        align-items: center;
        padding: 0.8rem 1rem;
        border-radius: 12px;
        transition: 0.3s;
        margin-bottom: 0.5rem;
        border: none;
        background: none;
        width: 100%;
        text-align: left;
        font-size: 1rem;
        cursor: pointer;
      }
      .nav-link i {
        margin-right: 1rem;
        width: 20px;
        text-align: center;
      }
      .nav-link:hover,
      .nav-link.active {
        background: rgba(197, 160, 89, 0.1);
        color: var(--primary);
      }
      .logout-link {
        margin-top: auto;
        color: var(--danger);
        opacity: 0.8;
      }
      .logout-link:hover {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger);
        opacity: 1;
      }

      /* Main Content Area */
      .main-content {
        flex-grow: 1;
        padding: 2.5rem;
        overflow-y: auto;
        max-width: calc(100vw - 260px);
      }
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
      }
      .header h1 {
        font-size: 1.8rem;
        font-weight: 600;
      }

      /* Components */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2.5rem;
      }
      .stat-card {
        background: var(--card);
        padding: 1.5rem;
        border-radius: 20px;
        border: 1px solid var(--border);
        transition: 0.3s;
      }
      .stat-card:hover {
        transform: translateY(-5px);
        border-color: var(--primary);
      }
      .stat-card h3 {
        font-size: 0.9rem;
        color: var(--text-dim);
        margin-bottom: 0.5rem;
      }
      .stat-card p {
        font-size: 2rem;
        font-weight: 600;
        color: var(--primary);
      }

      .btn {
        padding: 0.8rem 1.5rem;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
        border: none;
        transition: 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
        font-size: 0.9rem;
      }
      .btn-primary {
        background: var(--primary);
        color: #1e293b;
      }
      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(197, 160, 89, 0.3);
      }
      .btn-secondary {
        background: rgba(255, 255, 255, 0.05);
        color: var(--text);
        border: 1px solid var(--border);
      }
      .btn-danger {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger);
      }
      .btn-danger:hover {
        background: var(--danger);
        color: white;
      }

      .table-container {
        background: var(--card);
        border-radius: 20px;
        border: 1px solid var(--border);
        overflow: hidden;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th {
        text-align: left;
        padding: 1.2rem;
        color: var(--text-dim);
        font-weight: 400;
        font-size: 0.9rem;
        border-bottom: 1px solid var(--border);
      }
      td {
        padding: 1.2rem;
        border-bottom: 1px solid var(--border);
        vertical-align: middle;
      }
      tr:last-child td {
        border-bottom: none;
      }
      tr:hover {
        background: rgba(255, 255, 255, 0.02);
      }
      .product-img {
        width: 50px;
        height: 50px;
        border-radius: 10px;
        object-fit: cover;
        background: #000;
      }

      .status-pill {
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
      }
      .status-active {
        background: rgba(34, 197, 94, 0.1);
        color: var(--success);
      }
      .status-inactive {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger);
      }
      .status-warning {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning);
      }

      /* Form Styling */
      .form-card {
        background: var(--card);
        border-radius: 24px;
        border: 1px solid var(--border);
        padding: 2.5rem;
        position: relative;
      }
      .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
      }
      .full-width {
        grid-column: 1 / -1;
      }
      .form-group {
        margin-bottom: 1.5rem;
      }
      label {
        display: block;
        margin-bottom: 0.5rem;
        color: var(--text-dim);
        font-size: 0.9rem;
      }
      input,
      select,
      textarea {
        width: 100%;
        padding: 0.8rem 1rem;
        background: rgba(15, 23, 42, 0.5);
        border: 1px solid var(--border);
        border-radius: 12px;
        color: white;
        font-family: inherit;
        font-size: 1rem;
        transition: 0.3s;
      }
      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(197, 160, 89, 0.1);
      }

      .image-uploader {
        border: 2px dashed var(--border);
        border-radius: 20px;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: 0.3s;
        margin-bottom: 1.5rem;
      }
      .image-uploader:hover {
        border-color: var(--primary);
        background: rgba(197, 160, 89, 0.03);
      }
      .preview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
      }
      .preview-item {
        position: relative;
        aspect-ratio: 1;
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid var(--border);
      }
      .preview-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .remove-img {
        position: absolute;
        top: 5px;
        right: 5px;
        background: var(--danger);
        color: white;
        border: none;
        border-radius: 50%;
        width: 22px;
        height: 22px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
      }

      /* General Utils */
      .loader {
        display: none;
        text-align: center;
        padding: 2rem;
        color: var(--primary);
      }
      .spinner {
        animation: rotate 2s linear infinite;
        width: 40px;
        height: 40px;
        margin: 0 auto 1rem;
      }
      @keyframes rotate {
        100% {
          transform: rotate(360deg);
        }
      }
      .toast {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        padding: 1rem 2rem;
        border-radius: 12px;
        background: var(--sidebar);
        border: 1px solid var(--primary);
        color: white;
        z-index: 1000;
        display: none;
        animation: slideUp 0.3s ease;
      }
      @keyframes slideUp {
        from {
          transform: translateY(100px);
        }
        to {
          transform: translateY(0);
        }
      }

      /* Responsive */
      @media (max-width: 900px) {
        .sidebar {
          width: 80px;
          padding: 1rem;
        }
        .logo,
        .nav-link span {
          display: none;
        }
        .main-content {
          max-width: calc(100vw - 80px);
        }
        .form-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <!-- 1. LOGIN VIEW -->
    <div id="loginView" class="page-view active">
      <div class="login-card">
        <h1>LAVELLA</h1>
        <p>Administrative Access Only</p>
        <form id="loginForm">
          <div class="form-group">
            <label>Username</label>
            <input
              type="text"
              id="loginUser"
              required
              placeholder="Enter username"
            />
          </div>
          <div class="form-group">
            <label>Password</label>
            <input
              type="password"
              id="loginPass"
              required
              placeholder="Enter password"
            />
          </div>
          <button
            type="submit"
            class="btn btn-primary"
            style="width: 100%; justify-content: center; margin-top: 1rem"
          >
            Login System
          </button>
        </form>
        <div
          id="loginError"
          style="
            color: var(--danger);
            margin-top: 1rem;
            text-align: center;
            font-size: 0.9rem;
            display: none;
          "
        ></div>
      </div>
    </div>

    <!-- 2. ADMIN LAYOUT (DASHBOARD & APP) -->
    <div id="adminLayout" class="page-view">
      <aside class="sidebar">
        <a href="#" class="logo" onclick="showSection('products')">LAVELLA</a>
        <button class="nav-link active" onclick="showSection('products')">
          <i class="fas fa-box"></i> <span>Products</span>
        </button>
        <button class="nav-link" onclick="showSection('categories')">
          <i class="fas fa-list"></i> <span>Categories</span>
        </button>
        <button class="nav-link logout-link" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
        </button>
      </aside>

      <main class="main-content">
        <!-- PRODUCTS SECTION -->
        <section id="productsSection" class="section-view active">
          <div class="header">
            <h1>Product Portfolio</h1>
            <button class="btn btn-primary" onclick="openProductForm()">
              <i class="fas fa-plus"></i> New Product
            </button>
          </div>

          <div class="stats-grid">
            <div class="stat-card">
              <h3>Total Products</h3>
              <p id="statTotal">0</p>
            </div>
            <div class="stat-card">
              <h3>Active</h3>
              <p id="statActive" style="color: var(--success)">0</p>
            </div>
            <div class="stat-card">
              <h3>Featured</h3>
              <p id="statFeatured" style="color: var(--warning)">0</p>
            </div>
          </div>

          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Image</th>
                  <th>Product Details</th>
                  <th>Category</th>
                  <th>Pricing</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="productTableBody">
                <!-- JS Loaded -->
              </tbody>
            </table>
            <div id="productLoader" class="loader">
              <i class="fas fa-spinner fa-spin"></i> Loading Portfolio...
            </div>
          </div>
        </section>

        <!-- PRODUCT FORM SECTION -->
        <section id="productFormSection" class="section-view">
          <div class="header">
            <h1 id="formTitle">Create New Product</h1>
            <button class="btn btn-secondary" onclick="showSection('products')">
              Cancel
            </button>
          </div>
          <form id="productForm" class="form-card">
            <input type="hidden" id="editProductId" />
            <div class="form-grid">
              <div class="form-group full-width">
                <label>Product Title</label>
                <input
                  type="text"
                  id="title"
                  required
                  placeholder="e.g. Premium Silk Velvet Curtain"
                />
              </div>
              <div class="form-group">
                <label>Category</label>
                <select id="catSelect" required onchange="handleCatChange()">
                  <option value="">Select Category</option>
                </select>
              </div>
              <div class="form-group">
                <label>Subcategory</label>
                <select id="subSelect">
                  <option value="">Select Subcategory</option>
                </select>
              </div>
              <div class="form-group">
                <label>Original Price (₹)</label>
                <input type="number" id="priceOrig" placeholder="0.00" />
              </div>
              <div class="form-group">
                <label>Discounted Price (₹)</label>
                <input type="number" id="priceDisc" placeholder="0.00" />
              </div>
              <div class="form-group full-width">
                <label>Description</label>
                <textarea
                  id="desc"
                  rows="4"
                  placeholder="Detailed product description..."
                ></textarea>
              </div>
            </div>

            <div style="margin-top: 2rem">
              <label>Product Images</label>
              <div
                class="image-uploader"
                onclick="document.getElementById('imgInput').click()"
              >
                <i
                  class="fas fa-cloud-upload-alt fa-3x"
                  style="
                    color: var(--primary);
                    margin-bottom: 1rem;
                    display: block;
                  "
                ></i>
                <strong>Browse Images</strong>
                <p
                  style="
                    color: var(--text-dim);
                    font-size: 0.8rem;
                    margin-top: 0.5rem;
                  "
                >
                  Upload up to 10 high-quality images (JPG, PNG)
                </p>
                <input
                  type="file"
                  id="imgInput"
                  multiple
                  hidden
                  accept="image/*"
                  onchange="handleImgUpload(event)"
                />
              </div>
              <div class="preview-grid" id="imgPreviews"></div>
            </div>

            <div class="form-grid" style="margin-top: 2rem">
              <div class="form-group">
                <label>Material Used (Comma Separated)</label>
                <input
                  type="text"
                  id="mats"
                  placeholder="e.g. Silk, Polyester"
                />
              </div>
              <div class="form-group">
                <label>Color & Textures (Comma Separated)</label>
                <input
                  type="text"
                  id="cols"
                  placeholder="e.g. Golden, Smooth"
                />
              </div>
            </div>

            <div style="display: flex; gap: 2rem; margin-top: 1rem">
              <label
                style="
                  display: flex;
                  align-items: center;
                  gap: 0.5rem;
                  cursor: pointer;
                "
              >
                <input
                  type="checkbox"
                  id="isFeatured"
                  style="width: 18px; height: 18px"
                />
                Featured Product
              </label>
              <label
                style="
                  display: flex;
                  align-items: center;
                  gap: 0.5rem;
                  cursor: pointer;
                "
              >
                <input
                  type="checkbox"
                  id="isActive"
                  checked
                  style="width: 18px; height: 18px"
                />
                Active / Visible
              </label>
            </div>

            <div
              class="submit-section"
              style="margin-top: 2.5rem; display: flex; gap: 1rem"
            >
              <button type="submit" class="btn btn-primary" id="saveBtn">
                Save Product Entity
              </button>
              <div
                id="saveLoader"
                style="display: none; align-items: center; gap: 0.5rem"
              >
                <i class="fas fa-spinner fa-spin"></i> Processing...
              </div>
            </div>
          </form>
        </section>

        <!-- CATEGORIES SECTION - Placeholder -->
        <section id="categoriesSection" class="section-view">
          <div class="header"><h1>Managed Taxonomies</h1></div>
          <div
            class="form-card"
            style="text-align: center; color: var(--text-dim)"
          >
            <i class="fas fa-tools fa-3x" style="margin-bottom: 1rem"></i>
            <p>Category Management Module is under active development.</p>
          </div>
        </section>
      </main>
    </div>

    <div id="toast" class="toast"></div>

    <script>
      const API_URL = "/api";
      let currentImages = [];
      let categories = [];
      let token = localStorage.getItem("lavella_token");

      // Initial Logic
      document.addEventListener("DOMContentLoaded", () => {
        if (token) {
          checkAuth();
        } else {
          showView("login");
        }
      });

      function showView(view) {
        document
          .querySelectorAll(".page-view")
          .forEach((v) => v.classList.remove("active"));
        document.getElementById(view + "View").classList.add("active");
        if (view === "admin") {
          showSection("products");
          loadStats();
          loadCategories();
        }
      }

      function showSection(section) {
        document
          .querySelectorAll(".section-view")
          .forEach((s) => s.classList.remove("active"));
        document
          .querySelectorAll(".nav-link")
          .forEach((l) => l.classList.remove("active"));

        document.getElementById(section + "Section").classList.add("active");
        // Find nav button
        const navBtn = Array.from(document.querySelectorAll(".nav-link")).find(
          (btn) => btn.getAttribute("onclick").includes(section)
        );
        if (navBtn) navBtn.classList.add("active");

        if (section === "products") loadProducts();
      }

      // --- AUTH ---
      document.getElementById("loginForm").onsubmit = async (e) => {
        e.preventDefault();
        const btn = e.target.querySelector("button");
        const errDisplay = document.getElementById("loginError");

        btn.disabled = true;
        btn.textContent = "Authenticating...";
        errDisplay.style.display = "none";

        try {
          const res = await fetch(`${API_URL}/admin/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              username: document.getElementById("loginUser").value,
              password: document.getElementById("loginPass").value,
            }),
          });

          const data = await res.json();

          if (!res.ok) {
            throw new Error(data.message || "Invalid Login");
          }
          if (data.success) {
            token = data.token;
            localStorage.setItem("lavella_token", token);
            showView("admin");
          } else {
            showError(data.message || "Access Denied");
          }
        } catch (err) {
          console.error("Login Error:", err);
          showError("Login Error: " + err.message);
        } finally {
          btn.disabled = false;
          btn.textContent = "Login System";
        }
      };

      async function checkAuth() {
        if (!token) {
          showView("login");
          return;
        }

        try {
          const res = await fetch(`${API_URL}/admin/verify`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (res.ok) {
            showView("admin");
          } else {
            logout();
          }
        } catch (err) {
          // If server is down, but we have a token, we might still show admin
          // but API calls will fail anyway. Safer to just show login if we can't verify.
          showView("login");
        }
      }

      function logout() {
        localStorage.removeItem("lavella_token");
        token = null;
        showView("login");
      }

      function showError(msg) {
        const err = document.getElementById("loginError");
        err.textContent = msg;
        err.style.display = "block";
      }

      // --- PRODUCTS ---
      async function loadProducts() {
        const loader = document.getElementById("productLoader");
        const body = document.getElementById("productTableBody");
        loader.style.display = "block";
        body.innerHTML = "";

        try {
          const res = await fetch(`${API_URL}/products`);
          const data = await res.json();
          if (data.success) {
            renderProducts(data.data);
            updateProductStats(data.data);
          }
        } catch (e) {
          notify("Failed to load products");
        } finally {
          loader.style.display = "none";
        }
      }

      function renderProducts(prods) {
        const body = document.getElementById("productTableBody");
        body.innerHTML = prods
          .map(
            (p) => `
                <tr>
                    <td><img src="${
                      p.images[0] || "https://via.placeholder.com/50"
                    }" class="product-img"></td>
                    <td>
                        <div style="font-weight: 600">${p.title}</div>
                        <div style="font-size: 0.75rem; color: var(--text-dim)">${
                          p.subcategory || "General"
                        }</div>
                    </td>
                    <td>${p.category || "N/A"}</td>
                    <td>
                        <div style="font-size: 1rem; font-weight: 500">₹${
                          p.discounted_price || p.original_price
                        }</div>
                        ${
                          p.discounted_price
                            ? `<div style="font-size: 0.7rem; color: var(--text-dim); text-decoration: line-through">₹${p.original_price}</div>`
                            : ""
                        }
                    </td>
                    <td><span class="status-pill ${
                      p.is_active ? "status-active" : "status-inactive"
                    }">${p.is_active ? "Active" : "Private"}</span></td>
                    <td>
                        <div style="display:flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" style="padding: 0.5rem" onclick="editProduct('${
                              p._id
                            }')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-danger" style="padding: 0.5rem" onclick="deleteProduct('${
                              p._id
                            }')"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>
            `
          )
          .join("");
      }

      async function loadCategories() {
        try {
          const res = await fetch(`${API_URL}/categories`);
          const data = await res.json();
          if (data.success) {
            categories = data.data;
            const select = document.getElementById("catSelect");
            select.innerHTML =
              '<option value="">Select Category</option>' +
              categories
                .map((c) => `<option value="${c.name}">${c.name}</option>`)
                .join("");
          }
        } catch (e) {}
      }

      function handleCatChange() {
        const val = document.getElementById("catSelect").value;
        const subSelect = document.getElementById("subSelect");
        const cat = categories.find((c) => c.name === val);
        if (cat && cat.subcategories) {
          subSelect.innerHTML =
            '<option value="">Select Subcategory</option>' +
            cat.subcategories
              .map((s) => `<option value="${s}">${s}</option>`)
              .join("");
        } else {
          subSelect.innerHTML = '<option value="">Select Subcategory</option>';
        }
      }

      function openProductForm() {
        document.getElementById("productForm").reset();
        document.getElementById("editProductId").value = "";
        document.getElementById("formTitle").textContent = "Create New Product";
        currentImages = [];
        renderImgPreviews();
        showSection("productForm");
      }

      async function editProduct(id) {
        const res = await fetch(`${API_URL}/products/${id}`);
        const data = await res.json();
        if (data.success) {
          const p = data.data;
          openProductForm();
          document.getElementById("formTitle").textContent =
            "Modify Product Entity";
          document.getElementById("editProductId").value = p._id;
          document.getElementById("title").value = p.title;
          document.getElementById("catSelect").value = p.category;
          handleCatChange();
          document.getElementById("subSelect").value = p.subcategory || "";
          document.getElementById("priceOrig").value = p.original_price;
          document.getElementById("priceDisc").value = p.discounted_price || "";
          document.getElementById("desc").value = p.description || "";
          document.getElementById("mats").value = (p.material_used || []).join(
            ", "
          );
          document.getElementById("cols").value = (
            p.color_and_texture || []
          ).join(", ");
          document.getElementById("isFeatured").checked = p.featured;
          document.getElementById("isActive").checked = p.is_active;
          currentImages = p.images || [];
          renderImgPreviews();
        }
      }

      async function deleteProduct(id) {
        if (!confirm("Exterminate this product?")) return;
        try {
          const res = await fetch(`${API_URL}/products/${id}`, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await res.json();
          if (data.success) {
            notify("Product deleted successfully");
            loadProducts();
          }
        } catch (e) {
          notify("Deletion failed");
        }
      }

      // --- IMAGE HANDLING ---
      async function handleImgUpload(e) {
        const files = e.target.files;
        if (!files.length) return;

        const fd = new FormData();
        for (let f of files) fd.append("images", f);

        notify("Uploading assets...");
        try {
          const res = await fetch(`${API_URL}/upload/multiple`, {
            method: "POST",
            headers: { Authorization: `Bearer ${token}` },
            body: fd,
          });
          const data = await res.json();
          if (data.success) {
            currentImages = [...currentImages, ...data.image_urls];
            renderImgPreviews();
            notify("Upload finished");
          }
        } catch (err) {
          notify("Upload failed");
        }
      }

      function renderImgPreviews() {
        const grid = document.getElementById("imgPreviews");
        grid.innerHTML = currentImages
          .map(
            (img, i) => `
                <div class="preview-item">
                    <img src="${img}">
                    <button type="button" class="remove-img" onclick="removeImg(${i})">&times;</button>
                </div>
            `
          )
          .join("");
      }

      function removeImg(i) {
        currentImages.splice(i, 1);
        renderImgPreviews();
      }

      // --- SUBMIT PRODUCT ---
      document.getElementById("productForm").onsubmit = async (e) => {
        e.preventDefault();
        const id = document.getElementById("editProductId").value;
        const loader = document.getElementById("saveLoader");
        const btn = document.getElementById("saveBtn");

        loader.style.display = "flex";
        btn.style.display = "none";

        const payload = {
          title: document.getElementById("title").value,
          category: document.getElementById("catSelect").value,
          subcategory: document.getElementById("subSelect").value,
          original_price: Number(document.getElementById("priceOrig").value),
          discounted_price: Number(document.getElementById("priceDisc").value),
          description: document.getElementById("desc").value,
          material_used: document
            .getElementById("mats")
            .value.split(",")
            .map((s) => s.trim())
            .filter((s) => s),
          color_and_texture: document
            .getElementById("cols")
            .value.split(",")
            .map((s) => s.trim())
            .filter((s) => s),
          images: currentImages,
          featured: document.getElementById("isFeatured").checked,
          is_active: document.getElementById("isActive").checked,
        };

        try {
          const url = id ? `${API_URL}/products/${id}` : `${API_URL}/products`;
          const method = id ? "PUT" : "POST";
          const res = await fetch(url, {
            method,
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          if (data.success) {
            notify(id ? "Product updated" : "Product created");
            showSection("products");
          } else {
            notify(data.message || "Validation Error");
          }
        } catch (err) {
          notify("Network error");
        } finally {
          loader.style.display = "none";
          btn.style.display = "flex";
        }
      };

      // --- UTILS ---
      function loadStats() {
        /* Placeholder for backend stats endpoint if exists */
      }
      function updateProductStats(prods) {
        document.getElementById("statTotal").textContent = prods.length;
        document.getElementById("statActive").textContent = prods.filter(
          (p) => p.is_active
        ).length;
        document.getElementById("statFeatured").textContent = prods.filter(
          (p) => p.featured
        ).length;
      }

      function notify(msg) {
        const toast = document.getElementById("toast");
        toast.textContent = msg;
        toast.style.display = "block";
        setTimeout(() => {
          toast.style.display = "none";
        }, 3000);
      }
    </script>
  </body>
</html>
